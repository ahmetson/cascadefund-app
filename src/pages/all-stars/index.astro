---
import GalaxyLayout from "@/layouts/GalaxyLayout.astro";
import { MenuName } from "@/components/navbar/WorkNavbar.astro";

import UniverseHero from "@/components/galactic/UniverseHero";
import AllStarsLeaderboardPanel from "@/components/galactic/AllStarsLeaderboardPanel";
import AllStarsLeaderboardPanels from "@/components/galactic/AllStarsLeaderboardPanels";
import UniverseResearchPanel from "@/components/galactic/UniverseResearchPanel";
import GalaxyAutoZoom from "@/components/galactic/GalaxyAutoZoom";
import BackButton from "@/components/custom-ui/BackButton";
import NewGalaxyButton from "@/components/galactic/NewGalaxyButton";
import DemoCtaPanel from "@/components/project/DemoCtaPanel";
import {
  mockUniverseStats,
  mockContestData,
  mockTopGalaxies,
  mockTopLibraries,
} from "@/data/mock-data";

// Read galaxy query parameter
const galaxyId = Astro.url.searchParams.get("galaxy");
const selectedGalaxy = galaxyId
  ? mockTopGalaxies.find((g) => g.id === galaxyId)
  : null;

// Get current user's starsunshines (for demo, using 0 to show locked state)
const currentStarsunshines = 0;

// Check if user is logged in (check for common auth cookies)
const isLoggedIn =
  Astro.cookies.get("session")?.value !== undefined ||
  Astro.cookies.get("auth")?.value !== undefined ||
  Astro.cookies.get("user")?.value !== undefined ||
  Astro.cookies.get("token")?.value !== undefined;

// Check demo cookies
const demoCookie = Astro.cookies.get("demo");
const demoExpirationCookie = Astro.cookies.get("demo-expiration");

// Validate demo cookies
let areDemoCookiesValid = false;
if (demoCookie?.value && demoExpirationCookie?.value) {
  try {
    const expirationTimestamp = parseInt(demoExpirationCookie.value, 10);
    const now = Date.now();
    areDemoCookiesValid =
      !isNaN(expirationTimestamp) && expirationTimestamp > now;
  } catch (e) {
    areDemoCookiesValid = false;
  }
}

// Show DemoCtaPanel if user is not logged in and demo cookies are invalid
const shouldShowDemoCta = !isLoggedIn && !areDemoCookiesValid;

// Prepare all galaxies for display in the virtual screen
const allGalaxies = mockTopGalaxies.map((galaxy, index) => ({
  x: galaxy.x,
  y: galaxy.y,
  projectName: galaxy.name,
  projectId: galaxy.id,
  galaxyData: galaxy,
  tags: galaxy.tags,
  leaderboardPosition: index + 1,
}));
---

<GalaxyLayout
  active={MenuName.ProjectList}
  hideLinks={Object.keys(MenuName)}
  projectName="Ara Universe"
  projectX={selectedGalaxy?.x}
  projectY={selectedGalaxy?.y}
  projectGalaxies={allGalaxies}
>
  {
    selectedGalaxy && (
      <BackButton
        slot="left"
        client:only="react"
        uri={`/project?galaxy=${galaxyId}`}
      />
    )
  }

  <div slot="header-navbar" class="flex items-center justify-center pt-4">
    <NewGalaxyButton client:only="react" />
  </div>

  <UniverseHero
    slot="center"
    client:only="react"
    totalGalaxies={mockUniverseStats.totalGalaxies}
    totalStars={mockUniverseStats.totalStars}
    totalUsers={mockUniverseStats.totalUsers}
  />
  {shouldShowDemoCta && <DemoCtaPanel slot="center" client:only="react" />}

  <AllStarsLeaderboardPanel
    slot="right"
    client:only="react"
    prizePool={mockContestData.prizePool}
    contestFromDate={mockContestData.fromDate}
    contestToDate={mockContestData.toDate}
    contestDescription={mockContestData.description}
    leaderboardPosition={5}
  />

  <AllStarsLeaderboardPanels
    slot="left"
    client:only="react"
    topGalaxies={mockTopGalaxies}
    topLibraries={mockTopLibraries}
  />

  <UniverseResearchPanel
    slot="footer"
    client:only="react"
    starsunshines={currentStarsunshines}
  />

  <GalaxyAutoZoom
    client:only="react"
    galaxyX={selectedGalaxy?.x || 0}
    galaxyY={selectedGalaxy?.y || 0}
  />
</GalaxyLayout>
