---
import Layout from "@/layouts/PanelViewLayout.astro";
import { MenuName } from "@/components/navbar/WorkNavbar.astro";
import { ObjectId } from "mongodb";
import { getGalaxyById } from "@/scripts/galaxy";
import { getProjectById } from "@/scripts/project";
import MenuPanel from "@/components/menu/MenuPanel";
import QuestPanel from "@/components/quest/QuestPanel";
import Hyperspeed from "@/components/Hyperspeed";

// Get galaxy ID from query parameter
const galaxyIdParam = Astro.url.searchParams.get("galaxy");

// Validate galaxy ID
if (!galaxyIdParam) {
  return Astro.redirect("/project/404?method=getGalaxyParam");
}

// Validate ObjectId format
let galaxyId: ObjectId;
try {
  galaxyId = new ObjectId(galaxyIdParam);
} catch (error) {
  return Astro.redirect("/project/404?method=validateGalaxyId");
}

// Fetch galaxy from database
const galaxy = await getGalaxyById(galaxyIdParam);
if (!galaxy || !galaxy.projectLink) {
  return Astro.redirect("/project/404?method=getGalaxyById");
}

// Fetch project from database
const project = await getProjectById(galaxy.projectLink);
if (!project) {
  return Astro.redirect("/project/404?method=getProjectById");
}
// the component will fill the height/width of its parent container, edit the CSS to change this
// the options below are the default values
---

<Layout hideLinks={Object.keys(MenuName)}>
  <Hyperspeed
    effectOptions={{
      onSpeedUp: () => {},
      onSlowDown: () => {},
      distortion: "turbulentDistortion",
      length: 400,
      roadWidth: 10,
      islandWidth: 2,
      lanesPerRoad: 4,
      fov: 90,
      fovSpeedUp: 150,
      speedUp: 1.01,
      carLightsFade: 0.4,
      totalSideLightSticks: 12,
      lightPairsPerRoadWay: 20,
      shoulderLinesWidthPercentage: 0.05,
      brokenLinesWidthPercentage: 0.1,
      brokenLinesLengthPercentage: 0.5,
      lightStickWidth: [0.12, 0.5],
      lightStickHeight: [1.3, 1.7],
      movingAwaySpeed: [0.5, 1],
      movingCloserSpeed: [-1, -2],
      carLightsLength: [400 * 0.03, 400 * 0.2],
      carLightsRadius: [0.05, 0.14],
      carWidthPercentage: [0.3, 0.5],
      carShiftX: [-0.8, 0.8],
      carFloorSeparation: [0, 5],
      colors: {
        roadColor: 0x1a1a2e,
        islandColor: 0x1e1e3e,
        background: 0x0a0a1a,
        shoulderLines: 0xffd6e8,
        brokenLines: 0xffe5f0,
        leftCars: [0xffb3d9, 0xffcce6, 0xffd9f0],
        rightCars: [0xd4b3ff, 0xe6ccff, 0xf0d9ff],
        sticks: 0xffd6e8,
      },
    }}
    slot="background"
    className="fixed h-screen w-screen z-2 pointer-events-none opacity-40"
    client:load
  />
  <MenuPanel
    slot="left"
    activeMenuItem="guide"
    galaxy={galaxy}
    projectIcon={project.socialLinks?.find((link) => link.type === "project")
      ?.uri}
    projectName={galaxy.name}
    starCount={galaxy.stars}
  />
  <QuestPanel slot="center" title="Automatic Guide" client:load />
</Layout>
