---
import Layout from "@/layouts/PanelViewLayout.astro";
import BackButton from "@/components/custom-ui/BackButton";
import IssuePanel from "@/components/issue/IssuePanel";
import IssueStatsPanel from "@/components/issue/IssueStatsPanel";
import AssignToMeCTA from "@/components/issue/AssignToMeCTA";
import { getIssueById } from "@/scripts/issue";
import { ObjectId } from "mongodb";
import { MenuName } from "@/components/navbar/WorkNavbar.astro";

// Get issue ID and galaxy from query parameters
const issueIdParam = Astro.url.searchParams.get("id");
const galaxyParam = Astro.url.searchParams.get("galaxy");

// Validate issue ID
if (!issueIdParam) {
    return Astro.redirect("/project/404?method=getIssueIdParam");
}

// Validate ObjectId format
try {
    new ObjectId(issueIdParam);
} catch (error) {
    return Astro.redirect("/project/404?method=validateIssueId");
}

// Fetch issue from database
const issue = await getIssueById(issueIdParam);
if (!issue) {
    return Astro.redirect("/project/404?method=getIssueById");
}

// Build back button URI
const backUri = galaxyParam
    ? `/project/issues?galaxy=${galaxyParam}`
    : "/project/issues";
---

<Layout hideLinks={Object.keys(MenuName)}>
    <BackButton slot="left" uri={backUri} />

    <IssuePanel slot="center" {...issue} client:load />
    <AssignToMeCTA slot="center" client:only="react" issueId={issueIdParam} />
    <!-- <IssueStatsPanel slot="right" client:load /> -->
</Layout>
